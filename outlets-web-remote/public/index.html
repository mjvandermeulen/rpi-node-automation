<!DOCTYPE html>
<html>
  <head>
    <style>
      body {
        font-family: Verdana, Geneva, Tahoma, sans-serif;
        font-size: 150%;
      }

      h1 {
        font-size: 1.5em;
        font-weight: bold;
      }
      .btnOnOff {
        font-size: 0.8 em;
        background-color: white;
        color: black;
        border: 2px solid #e7e7e7;
        border-radius: 20px;
        padding: 15px 32px;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 16px;
        margin: 4px 2px;
        cursor: pointer;
        text-transform: uppercase;
      }
      .btnOnOff:focus {
        outline: 0 !important;
        background-color: #f2f2f2;
      }

      .btnOnOffActive {
        background-color: white;
        color: black;
        border: 2px solid #f44336;
      }

      #counters {
        visibility: visible;
      }
    </style>
  </head>
  <body>
    <div>
      <h1>Remote Outlets</h1>
      <p>
        <span class="btnTitle">
          living room
        </span>
      </p>
      <p>
        <button class="btnOnOff" id="livingroomOn">
          on
        </button>
        <button class="btnOnOff" id="livingroomOff">
          off
        </button>
      </p>
      <p>
        <span class="btnTitle">
          office
        </span>
      </p>
      <p>
        <button class="btnOnOff" id="officelightOn">
          on
        </button>
        <button class="btnOnOff" id="officelightOff">
          off
        </button>
        <span class="timer" id="officelightTimer">
          -:--:--
        </span>
        <button class="timerBtn" id="officelightplus">
          <!-- next names: officeplusplus ...minus ...minusminus -->
          +
        </button>
      </p>
      <p>
        <span class="btnTitle">
          filter
        </span>
      </p>
      <p>
        <button class="btnOnOff" id="filterOn">
          on
        </button>
        <button class="btnOnOff" id="filterOff">
          off
        </button>
      </p>
    </div>
    <div id="counters">
      <p>
        Incoming Socket Data count
        <span id="socCountIn">
          0
        </span>
      </p>
      <p>
        Outgoing Socket Data count
        <span id="socCountOut">
          0
        </span>
      </p>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.3/socket.io.js"></script>
    <!-- include socket.io client side script -->
    <script>
      var timer = {
        // milliseconds since epoch when timer should go off
        // 0 if not set
        livingroom: 0,
        officelight: 0,
        filter: 0,
      }

      // milliseconds
      const plus = 10 * 1000
      const plusplus = 30 * 60 * 1000
      const minus = -plus
      const minusminus = -plusplus

      function socketInCounterUp(spanId) {
        inCounter = document.getElementById(spanId)
        c = parseInt(inCounter.innerHTML) + 1
        inCounter.innerHTML = c.toString()
      }

      var socket = io() // load socket.io-client and connect to the host that serves the page

      function switchButton(data) {
        var onElement = document.getElementById(data.group + 'On')
        var offElement = document.getElementById(data.group + 'Off')
        if (data.mode) {
          onElement.classList.add('btnOnOffActive')
          offElement.classList.remove('btnOnOffActive')
        } else {
          onElement.classList.remove('btnOnOffActive')
          offElement.classList.add('btnOnOffActive')
        }
      }

      function addBtnEvent(group) {
        var onElement = document.getElementById(group + 'On')
        var offElement = document.getElementById(group + 'Off')

        onElement.addEventListener('click', function() {
          onElement.classList.add('btnOnOffActive')
          offElement.classList.remove('btnOnOffActive')
          socket.emit('light', {
            group: group,
            mode: true,
            sync: false,
            timer: -1,
          })
          socketInCounterUp('socCountOut')
        })

        offElement.addEventListener('click', function() {
          onElement.classList.remove('btnOnOffActive')
          offElement.classList.add('btnOnOffActive')
          socket.emit('light', {
            group: group,
            mode: false,
            sync: false,
            timer: -1,
          })
          socketInCounterUp('socCountOut')
        })
        socket.emit('light', {
          group: group,
          mode: false,
          sync: true, // request current value, to sync with other sockets
          timer: -1,
        })
      }

      function timeRemainingReadable(milliseconds) {
        function two(number) {
          if (number < 10) {
            return '0' + number.toString()
          } else {
            return number.toString()
          }
        }
        // TODO UPDATE: !!!secondsToHoursMinutesSeconds(3723) => "01:02:03"
        var milliSecondsLeft = milliseconds - Date.now()
        if (milliSecondsLeft < 1000) {
          return '-:--:--'
        }
        var hours = Math.floor(milliSecondsLeft / (60 * 60 * 1000))
        milliSecondsLeft = milliSecondsLeft % (60 * 60 * 1000)
        var minutes = Math.floor(milliSecondsLeft / (60 * 1000))
        milliSecondsLeft %= 60 * 1000
        secondsLeft = Math.floor(milliSecondsLeft / 1000)
        return `${two(hours)}:${two(minutes)}:${two(secondsLeft)}`
      }

      function refreshTimerDisplay(group) {
        if (timer[group] - Date.now() < 0) {
          // timer in the past
          timer[group] = 0
        }
        document.getElementById(
          group + 'Timer'
        ).innerHTML = timeRemainingReadable(timer[group])
      }

      function changeTimer(group, milliseconds) {
        if (timer[group] == 0) {
          // timer not set, assume prev timer set for Date.now()
          timer[group] = Date.now()
        }
        timer[group] += milliseconds
        if (timer[group] - Date.now() < 0) {
          // timer changed to time in past
          timer[group] = 0 // reset timer
        }
      }

      function broadcastTimer(group) {
        socket.emit('light', {
          group: group, //TODO: try group
          sync: false,
          mode: false,
          timer: timer[group],
        })
      }

      function addTimerEvent(group) {
        var plusElement = document.getElementById(group + 'plus')
        plusElement.addEventListener('click', function() {
          changeTimer(group, plus)
          refreshTimerDisplay(group)
          broadcastTimer(group)
        })
      }

      function runTimer(group) {
        var timerId = setInterval(() => {
          if (timer[group] > 0) {
            refreshTimerDisplay(group)
          }
        }, 1000)
        return timerId
      }

      window.addEventListener('load', function() {
        // old "load" event, even all images will have loaded
        // NOTE: you can click the on or off buttons even if they are "on"
        addBtnEvent('officelight')
        addBtnEvent('livingroom')
        addBtnEvent('filter')
        addTimerEvent('officelight')
        var timerId = runTimer('officelight')
        // clearInterval(timerId) // EXAMPLE: stop the timer
        socketInCounterUp('socCountOut')
      })

      socket.on('light', function(socketData) {
        socketInCounterUp('socCountIn')
        if (socketData.timer >= 0) {
          timer[socketData.group] = socketData.timer
          refreshTimerDisplay(socketData.group)
        } else {
          switchButton(socketData)
        }
        // console.log(data)
      })
    </script>
  </body>
</html>
